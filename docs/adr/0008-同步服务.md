# 8. 同步服务

Date: 2020-07-26

## Status

2020-07-26 proposed

## Context

同步服务可以满足以下需求：
 - 获取交易列表需要用到
 - 获取交易详情需要用到
 - 作为数据源推送链上事件到业务系统

同步需要解决以下问题：

| 难题 | 解决方法 |
| --- | --- |
| 某块同步的时候异常了，后面怎么再同步这个块，可能与部分tx已经同步好了 | 需要在解析tx的时候做持久化和重试机制 |
| 正在同步，又调用一次，会导致同一个块在两个job里面处理 | 同一条链只开一个同步服务 或者 在插入数据库的时候做冲突检测| 
| 现在只同步交易信息，是否有其他信息需要同步，比如余额，合约里面的信息，一些交易的状态信息等等 | 需要处理自定义合约信息，在架构上要设计 |
| 现在只同步Quorum，同步其他链如何增加 | 架构上要设计 |
| 如何结合现有调度框架 | 和[xxl-job兼容](https://github.com/xuxueli/xxl-job)|
| 线程中的网络请求的超时时间需要设置 | 设置合理的超时时间，防止阻塞 | 
| 如果某个节点长时间不出块，需要切换节点 | 监听至少两个节点，可以切换 | 
| w3j超时了，会在engine::run异常，如何切换节点| 监听至少两个节点，可以切换 |
| 同步block块的时候，如何分片并行进行处理。目前因为是判断最新块的高度，所以并行处理有些问题 | 批量处理，并做记号，不过目前顺序处理速度够快 |

## Decision

实现的优先级如下：
1. 实现同步链上信息的功能
2. 使用多线程处理交易
3. 兼容调度系统
4. 处理异常情况


## Consequences

Consequences here...
