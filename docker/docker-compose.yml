---
version: '2'
services:
  rabbitMQ:
    image: rabbitmq:management
    ports:
      - "5671:5671"
      - "5672:5672"
      - "4369:4369"
      - "25672:25672"
      - "15671:15671"
      - "15672:15672"
    networks:
      - backend

  backend:
    image: ${TW_WALLET_IMAGE}
    user: root
    volumes:
      - ${LOG_DIR}/backend:/app/logs
    environment:
      PROJECT_ENV: dev
      DB_URL: localhost
      DB_PORT: 5432
      DB_NAME: tw_wallet
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      RPC_URL: ${RPC_URL}
      TWPOINT_CONTRACT_ADDRESS: ${TWPOINT_CONTRACT_ADDRESS}
      IDENTITY_REGISTRY_CONTRACT_ADDRESS: ${IDENTITY_REGISTRY_CONTRACT_ADDRESS}
      NODE1_PRIVATE_KEY: ${NODE1_PRIVATE_KEY}
      LOG_DIR: ${LOG_DIR}
      swagger.enable: 'true'
      server.port: 8080
      RABBIT_MQ_URL: rabbitMQ
      RABBIT_MQ_PORT: 5672
      RABBIT_MQ_USERNAME: guest
      RABBIT_MQ_PASSWORD: guest
    depends_on:
      - rabbitMQ
    ports:
      - "80:8080"
    links:
      - rabbitMQ
    networks:
      - backend

  sync:
    image: ${TW_WALLET_IMAGE}
    user: root
    volumes:
      - ${LOG_DIR}/sync:/app/logs
    command: ["java", "-jar", "tw-wallet-sync.jar"]
    environment:
      PROJECT_ENV: dev
      DB_URL: localhost
      DB_PORT: 5432
      DB_NAME: tw_wallet
      DB_USERNAME: ${DB_USERNAME}
      DB_PASSWORD: ${DB_PASSWORD}
      RPC_URL: ${RPC_URL}
      TWPOINT_CONTRACT_ADDRESS: ${TWPOINT_CONTRACT_ADDRESS}
      IDENTITY_REGISTRY_CONTRACT_ADDRESS: ${IDENTITY_REGISTRY_CONTRACT_ADDRESS}
      NODE1_PRIVATE_KEY: ${NODE1_PRIVATE_KEY}
      LOG_DIR: ${LOG_DIR}
      swagger.enable: 'true'
      server.port: 8080
      RABBIT_MQ_URL: rabbitMQ
      RABBIT_MQ_PORT: 5672
      RABBIT_MQ_USERNAME: guest
      RABBIT_MQ_PASSWORD: guest
    depends_on:
      - backend
      - rabbitMQ
    links:
      - rabbitMQ
    networks:
      - backend

networks:
  backend:
    driver: bridge
